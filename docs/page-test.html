<html>

<head>
    <!-- TODO: Make this lib a GitHub pages resource? -->
    <!-- TODO: Possible to have local fallback for script load failure? -->
    <script name="lib-templates">
        const DEFAULT_PAGE = "main";
        var current_page = DEFAULT_PAGE;  // Needed to hide pages when switching

        function assert(condition, message = 'Assertion failed') {
            if (!condition) {
                throw new Error(message);
            }
        }

        function get_templates() {
            var template_elements = document.querySelectorAll(
                '[data-template]'
            );

            var templates = {};
            template_elements.forEach(element => {
                templates[element.dataset.template] = element;
            });

            return templates;
        }

        function instantiate_template(template_id) {
            var template = get_templates()[template_id];
            assert(template, `Invalid template name: ${template_id}`);

            // TODO(pbz): Since templates are instantiated at runtime, should
            // TODO(pbz): the name of the new instance be changed to "instance"?

            // Templates can have a "brain" class
            if (template.dataset.model != undefined) {
                // Get global variable by string name
                var model_class = eval(template.dataset.model);

                // Adding arbitrary property
                template.model_instance = new model_class(template);
                template.model_instance.init();
            }

            return template.cloneNode(true);
        }

        function render_templates() {
            var instances = document.querySelectorAll('[data-instance]');

            instances.forEach(element => {
                var template_name = element.dataset.instance;
                var instantiated_template = instantiate_template(template_name);
                show(instantiated_template);
                var parent = element.parentElement;
                parent.replaceChild(instantiated_template, element);
            });
        }

        function show(element) {
            element.removeAttribute('hidden');
        }

        function hide(element) {
            element.setAttribute('hidden', null);
        }

        function switch_page(name) {
            function get_pages() {
                var page_elements = document.querySelectorAll(
                    '[data-page]'
                );

                var pages = {};
                page_elements.forEach(
                    element => pages[element.dataset.page] = element
                );

                return pages;
            }

            var pages = get_pages();

            hide(pages[current_page]);
            current_page = name;
            show(pages[name]);
        }

        window.onload = function initialize() {
            switch_page(current_page);
            render_templates();
        };

        class Model {
            constructor(self) {
                this.self = self;
            }

            init() { }

            // Usage: get_child_element_by_attribute(element, 'id', 'variable-foo')
            get_child_element_by_attribute(attr, value) {
                return this.self.querySelector(`[${attr}="${value}"]`);
            }
        }
    </script>
    <script>

    </script>
</head>

<body>
    Content

    <!-- Main Page -->
    <div hidden data-page="main">
        <style>
            #page-main p {
                margin: 1em 0;
                color: #900;
            }

            #page-main em {
                color: #900;
            }
        </style>
        <p>Some content here... </p>
        <div data-instance="external-link"></div>
        <button onclick="switch_page('page-editor')">‚ÜóÔ∏è</button>
    </div>

    <!-- Page Editor Page -->
    <div hidden data-page="editor">
        <style>
            #page-editor p {
                margin: 1em 0;
                color: #900;
            }

            #page-editor em {
                color: #900;
            }
        </style>
        <a href="https://www.google.com">https://www.google.com</a>
        <div data-instance="external-link"></div>
        <button onclick="switch_page('page-main')">‚ÜôÔ∏è</button>
    </div>

    <p>‚û°Ô∏èSome other content‚¨ÖÔ∏è</p>
    <div data-instance="external-link"></div>
    <div data-instance="try-dataset"></div>
    <div data-instance="try-dataset"></div>

    <div hidden data-template="try-dataset" data-model="TemplateTryDataSet">
        <script>
            class TemplateTryDataSet extends Model {
                init() {
                    this.get_child_element_by_attribute('name', 'here').innerText = Math.random();
                }
            }
        </script>
        üî∞
        <i name="here">ASDF</i>
    </div>

    <!-- Templates can be instanced to prevent code duplication -->
    <div hidden data-template="external-link">
        <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="48" height="48" viewBox="0 0 48 48">
            <path fill="#90caf9"
                d="M37,46H17c-3.3,0-6-2.7-6-6V20c0-3.3,2.7-6,6-6h20c3.3,0,6,2.7,6,6v20C43,43.3,40.3,46,37,46z">
            </path>
            <path fill="none" stroke="#18193f" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10"
                stroke-width="3" d="M6.5,20.5v-5c0-3.3,2.7-6,6-6h10"></path>
            <path fill="none" stroke="#18193f" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10"
                stroke-width="3" d="M38.5,25.5v10c0,3.3-2.7,6-6,6h-20c-3.3,0-6-2.7-6-6v-7"></path>
            <line x1="23.5" x2="41.5" y1="24.5" y2="6.5" fill="none" stroke="#18193f" stroke-linecap="round"
                stroke-linejoin="round" stroke-miterlimit="10" stroke-width="3"></line>
            <polyline fill="none" stroke="#18193f" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10"
                stroke-width="3" points="27.5,6.5 41.5,6.5 41.5,20.5"></polyline>
        </svg>
    </div>
</body>

</html>